<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/metadata') %>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/postdetail.css">
    <title>Post</title>
</head>

<body>
    <% if (userid && username) { %>
    <%- include('partials/nav-Auth') %>
    <% } else { %>
    <%- include('partials/nav-unAuth') %>
    <% } %>


    <main>
        <div class="ui centered container" id="post-section">

            <div class="row" id="post-info">
                <div class="ui horizontal list" id="left-info">
                    <div class="item">
                        <img class="ui mini circular image" src="/icon.png">
                        <div class="content">
                            <h3 class="ui header"><%= post.user_name %></h3>
                            <%= post.post_date.toString().split(' ').slice(0, 4).join(' ') %><span id="sub-icon"><i
                                    class="fas fa-globe-asia"></i>
                            </span>
                        </div>
                    </div>
                </div>
                <div id="right-info">
                    <span>
                        <% for(let index = 1; index < parseInt(post.star); index++) { %>
                        <i class="fas fa-star choose"></i>
                        <% } %>
                    </span>
                    <span>At <strong><%= post.district_name %></strong></span>
                    <% if (userid === post.user_id) { %>
                    <div class="ui simple dropdown item">
                        <i class="fas fa-sort-down"></i>
                        <div class="menu">
                            <div class="item"><a href="#">delete</a></div>
                        </div>
                    </div>
                    <% } %>

                </div>

            </div>

            <div class="row" id="post-content">
                <div id="inner-content">
                    <h2 class="ui header"><%= post.title %></h2>
                    <p>
                        <%= post.content %>
                    </p>
                    <div class="ui small images">
                        <img class="ui image" src="/food.jpg" alt="food">
                        <img class="ui image" src="/food.jpg" alt="food">
                        <img class="ui image" src="/food.jpg" alt="food">
                        <img class="ui image" src="/food.jpg" alt="food">
                    </div>

                    <div id="tag-container">
                        <h5 class="ui header">Pop Lounge</h5>
                    </div>

                </div>

            </div>

            <div class="row">
                <div class="vote-section">
                    <h2 class="ui header">
                        <% if (userid && username) { %>
                        <i class="fas fa-arrow-up -vote -total"></i><span id="up-vote-total"><%= vote.up %></span>
                        <i class="fas fa-arrow-down -vote -total"></i><span id="down-vote-total"><%= vote.down %></span>
                        <% } else {%>
                        <a href="/login" style="color:#103667;"><i class="fas fa-arrow-up -vote -total"></i><span
                                id="up-vote-total"><%= vote.up %></span></a>
                        <a href="/login" style="color:#103667;"><i class="fas fa-arrow-down -vote -total"></i><span
                                id="down-vote-total"><%= vote.down %></span></a>
                        <% } %>
                    </h2>
                </div>
            </div>

            <% if (userid && username) { %>
            <div class="row" id="comment-compose">
                <form action="/comment/create" class="ui form" method="POST">
                    <div class="fields">
                        <input type="hidden" id="post-id" name="post_id" value="<%= postid %>">
                        <input type="hidden" id="user-id" name="user_id" value="<%= userid %>">
                        <input type="hidden" name="comment_date" value="<%= undefined %>">
                        <input type="hidden" name="report" value="<%= undefined %>">
                        <textarea rows="1" placeholder="Write a comment" spellcheck="false" id="comment" required
                            name="content"></textarea>
                        <button class="ui primary button">Submit</button>
                    </div>

                </form>
            </div>
            <% } else {%>
            <div class="row">
                <h3 class="ui header text-centered">
                    Please login to comment this post
                </h3>
            </div>
            <% } %>


            <div class="row">
                <div class="comment-section">
                    <div class="ui comments">
                        <% for(const cm of comment) { %>
                        <div class="comment">
                            <a class="avatar">
                                <img src="/icon.png">
                            </a>
                            <div class="content">
                                <a class="author"><%= cm.user_name %></a>
                                <div class="metadata">
                                    <div class="date" style="color: black;">
                                        <%= cm.comment_date.toString().split(' ').slice(0, 4).join(' ') %>
                                    </div>
                                    <!-- <div class="rating">
                                        <i class="fas fa-arrow-up"></i>
                                    </div> -->
                                </div>
                                <div class="text">
                                    <%= cm.content %>
                                </div>
                            </div>
                        </div>
                        <% } %>

                    </div>
                </div>
            </div>

        </div>
    </main>

    <script src="/nav-script.js"></script>
    <script src="/postdetail-script.js"></script>

    <% if (userid && username) { %>
    <script>
        const voteTotal = document.getElementsByClassName('-vote -total');
        const upVoteTotal = document.getElementById('up-vote-total');
        const downVoteTotal = document.getElementById('down-vote-total');
        const userid = document.getElementById('user-id').value;
        const postid = document.getElementById('post-id').value;

        function processVoteLogic(clicked, other, target, otherTarget) {
            if (clicked.classList.contains('color-voted')) {
                target.innerHTML = parseInt(target.innerHTML) - 1;
                try {
                    fetch('http://localhost:8080/vote', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: userid,
                            post_id: postid
                        })
                    })
                } catch (err) {
                    console.log(err)
                }
                clicked.classList.remove('color-voted');
            }
            else {
                clicked.classList.add('color-voted');
                target.innerHTML = parseInt(target.innerHTML) + 1;
                let type;
                if (clicked.classList.contains('fa-arrow-up'))
                    type = "True";
                else
                    type = "False";

                try {
                    fetch('http://localhost:8080/vote', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'

                        },
                        body: JSON.stringify({
                            user_id: userid,
                            post_id: postid,
                            type: type
                        })
                    })
                } catch (err) {
                    console.log(err);
                }
            }
            if (other.classList.contains('color-voted')) {
                otherTarget.innerHTML = parseInt(otherTarget.innerHTML) - 1;
            }
            other.classList.remove('color-voted');
        }

        for (let el of voteTotal) {
            el.addEventListener('click', (event) => {
                if (userid) {
                    if (event.target === voteTotal[0]) {
                        processVoteLogic(voteTotal[0], voteTotal[1], upVoteTotal, downVoteTotal);
                    } else {
                        processVoteLogic(voteTotal[1], voteTotal[0], downVoteTotal, upVoteTotal);
                    }
                }
            })
        }

    </script>
    <% } %>





    <%- include('partials/footer') %>

</body>

</html>